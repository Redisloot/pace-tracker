<script>
  let tapTimes = [];
  let resetTimer;

  function tapBeat() {
    const now = Date.now();

    // Reset inactivity timer
    clearTimeout(resetTimer);
    resetTimer = setTimeout(resetBPM, 2000);

    tapTimes.push(now);

    // Only keep the last few taps to smooth out BPM
    if (tapTimes.length > 5) {
      tapTimes.shift();
    }

    if (tapTimes.length > 1) {
      let intervals = [];
      for (let i = 1; i < tapTimes.length; i++) {
        intervals.push(tapTimes[i] - tapTimes[i - 1]);
      }
      let avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      let bpm = Math.round(60000 / avgInterval);

      document.getElementById("bpmDisplay").textContent = bpm + " BPM";
    }
  }

  function resetBPM() {
    // Don't clear the display, just reset tap history
    tapTimes = [];
  }

  async function submitBPM() {
    if (tapTimes.length < 2 && document.getElementById("bpmDisplay").textContent === "Tap to Start") {
      alert("Tap at least twice to calculate BPM before submitting.");
      return;
    }

    let bpmText = document.getElementById("bpmDisplay").textContent;
    let bpm = parseInt(bpmText);

    let location = "";
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        location = pos.coords.latitude + "," + pos.coords.longitude;
        sendData(bpm, location);
      }, () => {
        sendData(bpm, "Location unavailable");
      });
    } else {
      sendData(bpm, "Geolocation not supported");
    }
  }

  async function sendData(bpm, location) {
    await fetch("https://script.google.com/macros/s/AKfycbwtsjnlESTef7hzYHr5Hh3ftRSOGs5Ib0KDgDtj7HPBDA7xJgJaMFSYyWtXUSwgp4PZ/exec
", {
      method: "POST",
      body: JSON.stringify({
        bpm: bpm,
        time: new Date().toISOString(),
        location: location
      }),
      headers: { "Content-Type": "application/json" }
    });

    alert("BPM submitted: " + bpm);
    resetBPM();
  }
</script>
