<!DOCTYPE html>
<html>
<head>
  <title>IUB BPM Tracker</title>
  <style>
    body { text-align:center; font-family:sans-serif; margin-top:50px; }
    button { font-size:2em; padding:20px; margin:20px; }
  </style>
</head>
<body>
  <h1>IUB BPM Tracker</h1>
  <input type="text" id="userName" placeholder="Your Name">
  <br>
  <button id="tapButton">Tap to Beat</button>
  <button id="submitButton">Submit BPM</button>
  <p>Current BPM: <span id="bpm">0</span></p>
  <p id="status"></p>

  <script>
    let taps = [];
    let currentBPM = 0;
    const tapButton = document.getElementById("tapButton");
    const submitButton = document.getElementById("submitButton");
    const bpmDisplay = document.getElementById("bpm");
    const statusDisplay = document.getElementById("status");

    // Handle tap button
    tapButton.addEventListener("click", () => {
      const now = Date.now();
      taps.push(now);

      if (taps.length > 2) {
        let intervals = [];
        for (let i = 1; i < taps.length; i++) {
          intervals.push(taps[i] - taps[i - 1]);
        }
        let avg = intervals.reduce((a, b) => a + b) / intervals.length;
        currentBPM = Math.round(60000 / avg);
        bpmDisplay.textContent = currentBPM;
      }
    });

    // Handle submit button
    submitButton.addEventListener("click", () => {
      if (!currentBPM || currentBPM <= 0) {
        statusDisplay.textContent = "❌ Please tap a rhythm first!";
        return;
      }
      const name = document.getElementById("userName").value;
      const timestamp = new Date().toISOString();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          upload(name, currentBPM, timestamp, pos.coords.latitude, pos.coords.longitude);
        }, () => {
          upload(name, currentBPM, timestamp, "N/A", "N/A");
        });
      } else {
        upload(name, currentBPM, timestamp, "N/A", "N/A");
      }
    });

    function upload(name, bpm, time, lat, lon) {
      fetch("https://script.google.com/macros/s/AKfycbwtsjnlESTef7hzYHr5Hh3ftRSOGs5Ib0KDgDtj7HPBDA7xJgJaMFSYyWtXUSwgp4PZ/exec", {
        method: "POST",
        body: JSON.stringify({name, bpm, time, lat, lon}),
        headers: {"Content-Type": "application/json"}
      }).then(() => {
        statusDisplay.textContent = "✅ Submitted!";
        taps = []; // reset taps
        currentBPM = 0;
      }).catch(() => {
        statusDisplay.textContent = "⚠️ Error submitting!";
      });
    }
  </script>
</body>
</html>
